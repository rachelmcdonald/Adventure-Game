<!DOCTYPE html>
<html>
<head>
    <title>The Mosslit Path</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

    {% set scene_name = scene_name or '' %}

    <div class="fireflies">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="game-container">

        <div class="stats">
            ðŸŒ± Courage: {{ session.courage }} |
            ðŸª™ Gold: {{ session.gold }}
            {% if session.blessing %}| âœ¨ Blessed{% endif %}
        </div>
        <p style="color:yellow;">
            SCENE NAME: {{ scene_name }}
            </p>
            <p style="color:cyan;">
            COURAGE: {{ session.courage }}
        </p>

        {% if scene_text %}
            <p class="scene-text">{{ scene_text }}</p>
        {% else %}
            <p class="scene-text">Your adventure awaits! Press begin to start.</p>
        {% endif %}

        {% if scene_name and 'fairy' in scene_name %}
            <div class="character-area">
                <div class="fairy-wrapper
                    {% if scene_name == 'fairy_help' %} fairy--blessed {% endif %}
                    {% if scene_name == 'fairy_ignore' %} fairy--angry {% endif %}
                ">
                    <img src="{{ url_for('static', filename='images/fairy.png') }}" class="fairy-sprite {% if scene_name == 'left' %}bob{% else %}sway{% endif %}" alt="Forest Fairy"/>

                    <div class="sparkles"></div>
                </div>

                {% if scene_name == 'fairy_help' %}
                    <div class="dialogue-box">
                        <span class="typewriter">
                            âœ¨ "Hello travelerâ€¦ I am Luma of the Moss. May this light guide you."
                        </span>

                        <form action="{{ url_for('game') }}" method="post" class="dialogue-choices">
                            {% for value, label in options %}
                                <button type="submit" name="choice" value="{{ value }}" class="dialogue-btn">
                                    {{ label }}
                                </button>
                            {% endfor %}
                        </form>
                    </div>   
                {% elif scene_name == 'fairy_ignore' %}
                    <div class="dialogue-box dialogue-box--angry">
                        <span class="typewriter">
                            "...The forest remembers those who walk without kindness."
                        </span>

                        <form action="{{ url_for('game') }}" method="post" class="dialogue-choices">
                            {% for value, label in options %}
                                <button type="submit" name="choice" value="{{ value }}" class="dialogue-btn">
                                    {{ label }}
                                </button>
                            {% endfor %}
                        </form>
                    </div>   
                {% endif %}       
            </div>
        {% endif %}

        {% if 'wizard' in scene_name or scene_name == 'right' %}
            <div class="character-area">
                <div class="wizard-wrapper
                    {% if scene_name == 'wizard_talk' %} wizard-wrapper--blessed {% endif %}
                    {% if scene_name == 'wizard_pass' %} wizard-wrapper--angry {% endif %}
                ">
                    <img src="{{ url_for('static', filename='images/wizard.png') }}" class="wizard-sprite">

                    <div class="wizard-sparkles"></div>
                </div>
                    {% if scene_name == 'wizard_talk' %}

                        <div class="dialogue-box">
                            <span class="typewriter">
                                ðŸŒ¿ "The moss remembers kindness. Walk with courage, traveler."
                            </span>

                            <form action="{{ url_for('game') }}" method="post" class="dialogue-choices">
                                {% for value, label in options %}
                                    <button type="submit" name="choice" value="{{ value }}" class="dialogue-btn">
                                        {{ label }}
                                    </button>
                                {% endfor %}
                            </form>
                        </div>

                    {% elif scene_name == 'wizard_pass' %}
                        <div class="dialogue-box dialogue-box--angry">
                            <span class="typewriter">
                                "Sneaking through ancient woods is rarely wise."
                            </span>

                            <form action="{{ url_for('game') }}" method="post" class="dialogue-choices">
                                {% for value, label in options %}
                                    <button type="submit" name="choice" value="{{ value }}" class="dialogue-btn">
                                        {{ label }}
                                    </button>
                                {% endfor %}
                            </form>
                        </div>
                    {% endif %}          
            </div>
        {% endif %}

        {% set in_dialogue = scene_name in ['fairy_help', 'fairy_ignore', 'wizard_talk', 'wizard_pass'] %}

        {% if not in_dialogue %}
            <form action="{{ url_for('game') }}" method="post" class="choices">
                {% for value, label in options %}
                    <button type="submit" name="choice" value="{{ value }}" class="action-btn">
                        {{ label }}
                    </button>
                {% endfor %}
            </form>
        {% endif %}
    </div>

    <audio id="typeSound" preload="auto" src="{{ url_for('static', filename='sounds/type.wav') }}"></audio>
    
    <div id="fade-overlay"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const elements = document.querySelectorAll(".typewriter");
            const typeSound = document.getElementById("typeSound");

            if (typeSound) {
                typeSound.volume = 0;
                typeSound.play().then(() => {
                    typeSound.pause();
                    typeSound.currentTime = 0;
                    typeSound.volume = 0.25;
                }).catch(() => {});
            }

            elements.forEach(el => {
                const text = el.textContent;
                el.textContent = "";
                let i = 0;
                let typing = true;

                function type() {
                    if (i < text.length && typing) {
                        el.textContent += text.charAt(i);
                        i++;
                        setTimeout(type, 40);
                    }
                }

                el.addEventListener("click", () => {
                    typing = false;
                    el.textContent = text;
                });

                type();
            });

            const sparkleContainer = document.querySelector(".sparkles");
            if (sparkleContainer) {
                setInterval(() => {
                    const sparkle = document.createElement("span");
                    sparkle.style.left = Math.random() * 100 + "%";
                    sparkle.style.top = Math.random() * 100 + "%";
                    sparkle.style.animationDuration = 2 + Math.random() * 2 + "s";
                    sparkleContainer.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 4000);
                }, 300);
            }

            const wizardSparkles = document.querySelector(".wizard-sparkles");
            if (wizardSparkles) {
                setInterval(() => {
                    const sparkle = document.createElement("span");
                    sparkle.style.left = Math.random() * 100 + "%";
                    sparkle.style.top = Math.random() * 100 + "%";
                    wizardSparkles.appendChild(sparkle);
                    setTimeout(() => sparkle.remove(), 4000);
                }, 500);
            }

            const overlay = document.getElementById("fade-overlay");

            document.querySelectorAll("form").forEach(form => {
                form.addEventListener("submit", function (e) {
                    e.preventDefault();      
                    overlay.classList.add("active");

                    setTimeout(() => {
                        form.submit();
                    }, 600);          
                });
            });
        });

    </script>

</body>
</html>
